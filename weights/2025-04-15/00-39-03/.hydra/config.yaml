domain:
  train:
    lat:
      _target_: builtins.slice
      _args_:
      - -64.0
      - 64.0
    lon:
      _target_: builtins.slice
      _args_:
      - -64.0
      - 64.0
  test:
    lat:
      _target_: builtins.slice
      _args_:
      - -63.0
      - 63.0
    lon:
      _target_: builtins.slice
      _args_:
      - -63.0
      - 63.0
paths:
  stream_fun: /Odyssey/private/s23roy/project_QG/data/4dvar/stream_function_dataset_forcing_no_t_lr_128_dt=0.0002_save_freq=1600.nc
trainer:
  _target_: pytorch_lightning.Trainer
  inference_mode: false
  gradient_clip_val: 0.5
  accelerator: gpu
  devices: 1
  logger:
    _target_: pytorch_lightning.loggers.CSVLogger
    save_dir: ${hydra:runtime.output_dir}
    name: ${hydra:runtime.choices.xp}
    version: ''
  max_epochs: 500
  callbacks:
  - _target_: pytorch_lightning.callbacks.LearningRateMonitor
  - _target_: pytorch_lightning.callbacks.ModelCheckpoint
    monitor: val_mse
    save_top_k: 3
    filename: '{val_mse:.5f}-{epoch:03d}'
datamodule:
  _target_: src.data.BaseDataModule
  input_da:
    _target_: src.utils.load_qg_data
    path: ${paths.stream_fun}
  domains:
    train:
      time:
        _target_: builtins.slice
        _args_:
        - '2024-02-24'
        - '2024-09-29'
    val:
      time:
        _target_: builtins.slice
        _args_:
        - '2023-12-15'
        - '2024-02-24'
    test:
      time:
        _target_: builtins.slice
        _args_:
        - '2023-10-01'
        - '2023-12-20'
  xrds_kw:
    patch_dims:
      time: 10
      lat: 128
      lon: 128
    strides:
      time: 1
      lat: 128
      lon: 128
    domain_limits: ${domain.train}
  dl_kw:
    batch_size: 4
    num_workers: 1
  aug_kw:
    aug_factor: 2
    aug_only: true
model:
  _target_: src.models.Lit4dVarNet
  persist_rw: false
  opt_fn:
    _target_: src.utils.cosanneal_lr_adam
    _partial_: true
    lr: 0.001
    T_max: ${trainer.max_epochs}
  rec_weight:
    _target_: src.utils.get_triang_time_wei
    patch_dims: ${datamodule.xrds_kw.patch_dims}
    crop:
      time: 0
      lat: 0
      lon: 0
    offset: 1
  solver:
    _target_: src.models.GradSolver
    n_step: 15
    lr_grad: 1000.0
    prior_cost:
      _target_: src.models.BilinAEPriorCost
      dim_in: ${datamodule.xrds_kw.patch_dims.time}
      dim_hidden: 32
      bilin_quad: false
      downsamp: 2
    obs_cost:
      _target_: src.models.BaseObsCost
    grad_mod:
      _target_: src.models.ConvLstmGradModel
      dim_in: ${datamodule.xrds_kw.patch_dims.time}
      dim_hidden: 48
    init_state_fn:
      _target_: src.utils.warp_field_batch
      _partial_: true
      L: 5.0
      T_corr: 20.0
      sigma:
      - 0
      - 5.0
      - 10.0
      init_type: 3-level-perturbed
  test_metrics: ${metrics.test_metrics}
  pre_metric_fn:
    _target_: xarray.Dataset.sel
    _partial_: true
    time:
      _target_: builtins.slice
      _args_:
      - '2023-10-22'
      - '2023-12-02'
    lat: ${domain.test.lat}
    lon: ${domain.test.lon}
metrics:
  nrmse_scores:
    _target_: src.utils.rmse_based_scores_from_ds
    _partial_: true
  psd_scores:
    _target_: src.utils.psd_based_scores_from_ds
    _partial_: true
  get0:
    _target_: operator.itemgetter
    _args_:
    - 0
  get1:
    _target_: operator.itemgetter
    _args_:
    - 1
  test_metrics:
    mu:
      _target_: src.utils.pipe
      _partial_: true
      fns:
      - ${metrics.nrmse_scores}
      - ${metrics.get0}
    sig:
      _target_: src.utils.pipe
      _partial_: true
      fns:
      - ${metrics.nrmse_scores}
      - ${metrics.get1}
    lx:
      _target_: src.utils.pipe
      _partial_: true
      fns:
      - ${metrics.psd_scores}
      - ${metrics.get0}
    lt:
      _target_: src.utils.pipe
      _partial_: true
      fns:
      - ${metrics.psd_scores}
      - ${metrics.get1}
entrypoints:
- _target_: pytorch_lightning.seed_everything
  seed: 333
- _target_: src.train.base_training
  trainer: ${trainer}
  lit_mod: ${model}
  dm: ${datamodule}
